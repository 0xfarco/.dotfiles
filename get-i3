#!/bin/bash
set -e

detect_os() {
    if [[ -f /etc/artix-release ]]; then
        echo "artix"
    elif [[ -f /etc/os-release ]]; then
        source /etc/os-release
        if [[ "$ID" == "void" ]]; then
            echo "void"
        else
            echo "unknown"
        fi
    else
        echo "unknown"
    fi
}

OS=$(detect_os)
[[ "$OS" == "unknown" ]] && { echo "âŒ Unsupported OS."; exit 1; }

echo "ðŸ–¥ï¸ Detected OS: $OS"

# ----------- CONFIGURATION -----------

XORG_TOOLS_ARTIX=(libx11 libxft libxinerama xorg-server xorg-xinit xorg-xrandr)
I3_TOOLS_ARTIX=(i3-wm i3status)
FONT_TOOLS_ARTIX=(ttf-font-awesome ttf-jetbrains-mono-nerd noto-fonts noto-fonts-emoji ttf-dejavu)

XORG_TOOLS_VOID=(libX11-devel libXft-devel libXinerama-devel xorg-minimal xinit xrandr)
I3_TOOLS_VOID=(i3 i3status)
FONT_TOOLS_VOID=(font-awesome5 dejavu-fonts-ttf noto-fonts-emoji)

TOUCHPAD_CONF_FILE="./30-touchpad.conf"
CUSTOM_BASH_PROFILE="./append_profile"
CUSTOM_BASHRC="./append_bashrc"

# ----------- INSTALLATION -----------

install_packages() {
    local name="$1"
    shift
    local tools=("$@")

    echo "ðŸ“¦ Installing $name..."

    if [[ "$OS" == "artix" ]]; then
        sudo pacman -S --needed "${tools[@]}"
    else
        sudo xbps-install -Sy "${tools[@]}"
    fi
}

install_mandatory_packages() {
    if [[ "$OS" == "artix" ]]; then
        install_packages "Xorg Tools" "${XORG_TOOLS_ARTIX[@]}"
        install_packages "I3 Tools" "${I3_TOOLS_ARTIX[@]}"
        install_packages "Fonts" "${FONT_TOOLS_ARTIX[@]}"
    else
        install_packages "Xorg Tools" "${XORG_TOOLS_VOID[@]}"
        install_packages "I3 Tools" "${I3_TOOLS_VOID[@]}"
        install_packages "Fonts" "${FONT_TOOLS_VOID[@]}"
    fi
}

copy_touchpad() {
    echo "ðŸ–±ï¸ Installing touchpad configuration..."
    sudo install -Dm644 "$TOUCHPAD_CONF_FILE" /etc/X11/xorg.conf.d/30-touchpad.conf
}

safe_append() {
    local file="$1"
    local marker="# BEGIN custom additions"

    if ! grep -qF "$marker" "$file" 2>/dev/null; then
        echo "ðŸ”§ Updating $file..."
        {
            echo "$marker"
            cat "$2"
            echo "# END custom additions"
        } >> "$file"
    else
        echo "â„¹ï¸ Already modified: $file"
    fi
}

copy_i3_configs() {
    # Ensure the .config/i3 directory exists
    mkdir -p "$HOME/.config/i3"

    # Copy all i3 config files from current directory's i3/ to ~/.config/i3/
    if [[ -d ./i3 ]]; then
        cp -r ./i3/* "$HOME/.config/i3/"
        echo "ðŸ“‚ i3 configuration copied to ~/.config/i3/"
    else
        echo "âš ï¸ i3 config directory './i3' not found."
    fi

    # Copy .i3status.conf to $HOME
    if [[ -f .i3status.conf ]]; then
        cp .i3status.conf "$HOME/"
        echo "ðŸ“„ .i3status.conf copied to $HOME/"
    else
        echo "âš ï¸ .i3status.conf not found."
    fi
}

add_i3_block_to_xinitrc() {
    local file="$HOME/.xinitrc"

    # Create .xinitrc if missing
    [[ ! -f "$file" ]] && touch "$file"

    # Avoid duplicates
    if grep -q "exec i3" "$file"; then
        echo "â„¹ï¸ i3 block already in .xinitrc"
        return
    fi

    echo "ðŸ“ Adding i3 startup block to .xinitrc"

    # Choose wallpaper based on OS
    if [[ "$OS" == "void" ]]; then
        WALLPAPER_CMD='feh --bg-scale ~/Pictures/wallpaper/void-linux.png &'
    else
        WALLPAPER_CMD='feh --bg-scale ~/Pictures/wallpaper/artix.png &'
    fi

    cat >> "$file" << EOF
picom &
$WALLPAPER_CMD
sxhkd -c ~/.config/sxhkd/sxhkdrc &
exec i3
EOF
}

install_nerd_font() {
    local url="https://github.com/ryanoasis/nerd-fonts/releases/download/v3.4.0/JetBrainsMono.zip"
    local tmp_dir
    tmp_dir=$(mktemp -d)
    local zip_file="$tmp_dir/JetBrainsMono.zip"
    local extract_dir="$tmp_dir/JetBrainsMono"

    echo "â¬‡ï¸ Downloading JetBrainsMono Nerd Font..."
    wget -q --show-progress -O "$zip_file" "$url"

    echo "ðŸ“¦ Extracting JetBrainsMono.zip..."
    unzip -q "$zip_file" -d "$extract_dir"

    echo "ðŸ“‚ Moving JetBrainsMono fonts to /usr/share/fonts/JetBrainsMono..."
    sudo mkdir -p /usr/share/fonts/JetBrainsMono
    sudo cp -r "$extract_dir"/* /usr/share/fonts/JetBrainsMono/

    echo "ðŸ”„ Updating font cache..."
    sudo fc-cache -fv

    echo "âœ… JetBrainsMono Nerd Font installed."
    rm -rf "$tmp_dir"
}


# ----------- EXECUTION -----------

install_mandatory_packages
copy_touchpad
safe_append "$HOME/.bash_profile" "$CUSTOM_BASH_PROFILE"
safe_append "$HOME/.bashrc" "$CUSTOM_BASHRC"
copy_i3_configs
add_i3_block_to_xinitrc

# Conditionally install JetBrains Mono Nerd Font
if [[ "$OS" == "void" ]]; then
    install_nerd_font
fi

echo "âœ… i3 Setup complete!"
