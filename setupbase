#!/bin/bash

set -e  # Exit on any error

# ----------- CONFIGURATION -----------

MANDATORY_TOOLS=(
    libx11 libxft libxinerama xorg-server xorg-xinit xorg-xrandr base-devel 
    curl wget git polkit sxhkd rofi feh dunst picom github-cli
    tlp tlp-runit tlp-rdw thermald thermald-runit lm_sensors lm_sensors-runit
    libnotify calcurse firefox cmake nsxiv flameshot ffmpeg ffmpegthumbnailer
    neovim vim nano mpv vlc pcmanfm qbittorrent cronie cronie-runit libqalculate
    qalculate-qt man-db xclip zathura zathura-pdf-mupdf fzf brightnessctl htop
    slock slop pulseaudio pavucontrol pulsemixer newsboat tesseract
    tesseract-data-eng ttf-font-awesome ttf-jetbrains-mono-nerd
    noto-fonts noto-fonts-emoji yazi timeshift unzip
)

YAY_DIR="$HOME/.local/src/yay-bin"
DWM_DESKTOP_FILE="./dwm.desktop"
TOUCHPAD_CONF_FILE="./30-touchpad.conf"
CUSTOM_BASH_PROFILE="./append_profile"
CUSTOM_BASHRC="./append_bashrc"

# ----------- FUNCTIONS -----------

command_exists() {
    command -v "$1" &> /dev/null
}

# ----------- Install packages -----------

install_mandatory_tools() {
    echo "üì¶ Installing mandatory tools..."
    sudo pacman -S --needed "${MANDATORY_TOOLS[@]}"
}

# ----------- Install yay -----------

install_yay() {
    if command_exists yay; then
        echo "‚úÖ yay is already installed."
        return
    fi

    echo "üîß Setting up yay (AUR helper)..."
    sudo pacman -S --needed git base-devel
    rm -rf "$YAY_DIR"
    mkdir -p "$(dirname "$YAY_DIR")"
    git clone https://aur.archlinux.org/yay-bin.git "$YAY_DIR"
    cd "$YAY_DIR"
    makepkg -si
    cd -
}

# ----------- Copy config files -----------

copy_config_files() {
    echo "üñºÔ∏è Copying dwm.desktop to /usr/share/xsessions..."
    sudo mkdir -p /usr/share/xsessions
    sudo cp "$DWM_DESKTOP_FILE" /usr/share/xsessions/dwm.desktop

    echo "üñ±Ô∏è Copying 30-touchpad.conf to /etc/X11/xorg.conf.d/..."
    sudo mkdir -p /etc/X11/xorg.conf.d
    sudo cp "$TOUCHPAD_CONF_FILE" /etc/X11/xorg.conf.d/30-touchpad.conf
}

# ----------- Append to .bash_profile -----------

append_to_profile() {
    local marker="# BEGIN custom additions"
    if ! grep -qF "$marker" ~/.bash_profile; then
        echo "üìù Appending custom bash additions to ~/.bash_profile..."
        {
            echo "$marker"
            cat "$CUSTOM_BASH_PROFILE"
            echo "# END custom additions"
        } >> ~/.bash_profile
    else
        echo "‚ÑπÔ∏è Custom bash additions already present in ~/.bash_profile. Skipping."
    fi
}

# ----------- Append to .bashrc -----------

append_to_bashrc() {
    local marker="# BEGIN custom additions"
    if ! grep -qF "$marker" ~/.bashrc; then
        echo "üìù Appending custom bash additions to ~/.bashrc..."
        {
            echo "$marker"
            cat "$CUSTOM_BASHRC"
            echo "# END custom additions"
        } >> ~/.bashrc
    else
        echo "‚ÑπÔ∏è Custom bash additions already present in ~/.bashrc. Skipping."
    fi
}

# ----------- Create Public Recordings Directory -----------

create_recordings_dir() {
    echo "üìÅ Creating ~/Public/Recordings directory..."
    mkdir -p "$HOME/Public/Recordings"
}

# ----------- EXECUTION -----------

# Ensure we're on an Arch-based system
if ! command_exists pacman; then
    echo "‚ùå This script is only for Arch-based systems."
    exit 1
fi

install_mandatory_tools
install_yay
copy_config_files
append_to_profile
append_to_bashrc
create_recordings_dir

echo "‚úÖ Setup complete."
