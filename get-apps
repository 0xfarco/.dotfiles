#!/bin/bash
set -e

# ===============================
#   OS DETECTION
# ===============================

detect_os() {
    if command -v pacman >/dev/null 2>&1; then
        echo "artix"
    elif command -v xbps-install >/dev/null 2>&1; then
        echo "void"
    else
        echo "unknown"
    fi
}

OS=$(detect_os)

if [[ "$OS" == "unknown" ]]; then
    echo "âŒ Unsupported OS. This script only supports Artix & Void Linux."
    exit 1
fi

echo "ðŸ–¥ï¸ Detected OS: $OS"


# ===============================
#   PACKAGE LISTS
# ===============================

# --- AUDIO ---

if [[ "$OS" == "artix" ]]; then
    USE_PIPEWIRE=true
else
    USE_PIPEWIRE=false
fi

#AUDIO_ARTIX=(pulseaudio pulsemixer pavucontrol)
AUDIO_ARTIX=(pipewire pipewire-pulse wireplumber pipewire-alsa pavucontrol pulsemixer)
#AUDIO_VOID=(pipewire wireplumber pipewire-alsa pipewire-pulse pavucontrol pulsemixer)
AUDIO_VOID=(pulseaudio pavucontrol pulsemixer)

# --- POWER MANAGEMENT ---
POWER_ARTIX=(
    tlp tlp-runit tlp-rdw
    thermald thermald-runit
    lm_sensors lm_sensors-runit
)

POWER_VOID=(
    tlp tlp-rdw
    thermald
    lm_sensors
)

# --- OTHER TOOLS ---
OTHER_ARTIX=(
    base-devel curl wget git polkit sxhkd feh dunst picom github-cli
    libnotify calcurse cmake nsxiv flameshot ffmpeg ffmpegthumbnailer
    neovim vim nano mpv vlc qbittorrent cronie cronie-runit libqalculate
    qalculate-qt man-db xclip zathura zathura-pdf-mupdf fzf acpilight htop
    slock slop newsboat tesseract tesseract-data-eng unzip tmux
)

OTHER_VOID=(
    base-devel dbus linux-headers mesa mesa-intel-dri intel-video-accel xf86-video-intel
    curl wget git polkit sxhkd feh dunst picom github-cli
    libnotify calcurse make cmake nsxiv flameshot ffmpeg ffmpegthumbnailer
    neovim vim nano mpv vlc qbittorrent cronie libqalculate qalculate-qt
    man-pages man-db xclip zathura zathura-pdf-mupdf fzf acpilight htop
    slock slop newsboat tesseract tesseract-ocr-eng unzip tmux
    NetworkManager
)


# ===============================
#   PACKAGE INSTALLER
# ===============================

install_packages() {
    local label="$1"
    shift
    local pkgs=("$@")

    echo "ðŸ“¦ Installing: $label"

    if [[ "$OS" == "artix" ]]; then
        sudo pacman -S --needed "${pkgs[@]}"
    else
        sudo xbps-install -Sy "${pkgs[@]}"
    fi
}


install_all() {
    if [[ "$OS" == "artix" ]]; then
        install_packages "Pipewire" "${AUDIO_ARTIX[@]}"
        install_packages "Power Tools" "${POWER_ARTIX[@]}"
        install_packages "Other Tools" "${OTHER_ARTIX[@]}"
    else
        install_packages "Pipewire" "${AUDIO_VOID[@]}"
        install_packages "Power Tools" "${POWER_VOID[@]}"
        install_packages "Other Tools" "${OTHER_VOID[@]}"
    fi
}

# ===============================
#   AUR HELPER (ARTIX ONLY)
# ===============================

AUR_HELPER_DIR="$HOME/.local/src/paru"

install_aur() {
    if [[ "$OS" == "void" ]]; then
        echo "â„¹ï¸ Void Linux detected â€” skipping AUR helper."
        return
    fi

    if command_exists paru; then
        echo "âœ… paru is already installed."
        return
    fi

    echo "ðŸ”§ Installing paru (AUR helper)..."
    sudo pacman -S --needed git base-devel

    rm -rf "$AUR_HELPER_DIR"
    git clone https://aur.archlinux.org/paru.git "$AUR_HELPER_DIR"
    cd "$AUR_HELPER_DIR"
    makepkg -si
    cd -
}

# ===============================
#   CONFIG
# ===============================

add_pipewire_to_xinitrc() {
    local file="$HOME/.xinitrc"

    # Skip if user disabled PipeWire
    if [[ "$USE_PIPEWIRE" != true ]]; then
        echo "â„¹ï¸ PipeWire disabled â€” skipping .xinitrc"
        return
    fi

    # Avoid duplicates
    if grep -q "/usr/bin/pipewire" "$file"; then
        echo "â„¹ï¸ PipeWire already present in .xinitrc"
        return
    fi

    echo "ðŸ“ Adding PipeWire block to top of .xinitrc"

    # Prepend block
    {
        echo "/usr/bin/pipewire &"
        echo "/usr/bin/pipewire-pulse &"
        echo "/usr/bin/wireplumber &"
        #echo
        cat "$file"
    } > "${file}.tmp"

    mv "${file}.tmp" "$file"
}

# ===============================
#   EXECUTION
# ===============================

install_all
install_aur
add_pipewire_to_xinitrc

echo "âœ… Setup complete!"

